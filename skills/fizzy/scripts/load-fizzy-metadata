#!/usr/bin/env bash
set -euo pipefail

# Load Fizzy Metadata
# Fetches board IDs and column IDs for each board

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo -e "${BOLD}Loading Fizzy Metadata...${NC}"
echo ""

# Check if fizzy is available
if ! command -v fizzy &> /dev/null; then
    echo -e "${RED}Error: fizzy CLI not found${NC}"
    exit 1
fi

# Check if jq is available for JSON parsing
if ! command -v jq &> /dev/null; then
    echo -e "${RED}Error: jq is required for JSON parsing${NC}"
    exit 1
fi

# Fetch all boards
echo -e "${BLUE}Fetching boards...${NC}"
boards_json=$(fizzy board list --all --format=json 2>/dev/null)

if [ -z "$boards_json" ] || [ "$boards_json" = "[]" ]; then
    echo -e "${RED}No boards found or unable to fetch boards${NC}"
    exit 1
fi

# Parse and display boards with their columns
echo "$boards_json" | jq -r '.data[] | "\(.id)|\(.name)"' | while IFS='|' read -r board_id board_name; do
    echo -e "${GREEN}${BOLD}Board:${NC} ${BOLD}$board_name${NC}"
    echo -e "  ID: $board_id"
    echo ""

    # Fetch columns for this board
    columns_json=$(fizzy column list --board="$board_id" --all --format=json 2>/dev/null)

    if [ -n "$columns_json" ] && [ "$columns_json" != "[]" ]; then
        echo -e "  ${BLUE}Columns:${NC}"
        echo "$columns_json" | jq -r '.data[] | "    - \(.name): \(.id)"'
    else
        echo -e "  ${BLUE}Columns:${NC} (none)"
    fi

    echo ""
done

echo -e "${GREEN}Done!${NC}"
